const savedData = localStorage.getItem('my_workout_routine');
const workoutData = savedData ? JSON.parse(savedData) : { name: "ê¸°ë³¸ ë£¨í‹´", level: "intermediate" }; 
const app = document.getElementById('app');

let currentExIdx = 0;   
let currentSet = 1;     
let isEditing = false;
let workoutHistory = [];
let tempoTimer = null; 
let currentCount = 0;
let currentBeat = 0;
let tempo = 1.0;

// ìš´ë™ ë°ì´í„°ë² ì´ìŠ¤ (ë°ì´í„° ë™ê¸°í™”ë¥¼ ìœ„í•´ ì „ì—­ ê´€ë¦¬)
let exercises = [
    { name: "ë²¤ì¹˜í”„ë ˆìŠ¤", category: "ê°€ìŠ´", detail: "ì¤‘ë¶€", unitType: "weight", weight: 40, count: 12, time: 40, sets: 3 },
    { name: "ë³µê·¼ìš´ë™", category: "ë³µê·¼", detail: "ìƒí•˜ë³µë¶€", unitType: "count", goalCount: 30, sets: 3, restTime: 60 },
    { name: "ìŠ¤ì¿¼íŠ¸", category: "í•˜ì²´", detail: "ëŒ€í‡´ì‚¬ë‘", unitType: "time", weight: 0, count: 15, time: 40, sets: 4 }
];

function init() {
    renderExercise();
}

// ë ˆì´ì•„ì›ƒ ì—”ì§„ (ë²„íŠ¼ ê²¹ì¹¨ ë°©ì§€ êµ¬ì¡°)
function getFullLayout(contentHTML, btnHTML) {
    return `
        <div class="header-area">
            <button class="header-btn" onclick="toggleModal(true)">ìˆœì„œ í™•ì¸</button>
            <span style="font-weight:bold; color:#333;">ì¢…ëª© (${currentExIdx + 1}/${exercises.length})</span>
            <button class="header-btn exit-btn" onclick="renderReport()">ìš´ë™ ì¢…ë£Œ</button>
        </div>
        <div class="main-content">
            ${contentHTML}
        </div>
        <div class="action-area">
            ${btnHTML}
        </div>
    `;
}

function renderExercise() {
    if (tempoTimer) clearInterval(tempoTimer); // ì¤‘ë³µ íƒ€ì´ë¨¸ ë°©ì§€
    const ex = exercises[currentExIdx];
    
    // ëª¨ë“œ ì „í™˜ íƒ­
    const modeTabs = `
        <div class="mode-tab-container" style="display:flex; gap:10px; margin-bottom:20px; justify-content:center;">
            <div class="mode-tab ${ex.unitType==='weight'?'active':''}" onclick="changeMode('weight')" style="cursor:pointer; padding:5px 15px; border:1px solid #ddd; border-radius:20px;">ë¬´ê²Œ+íšŸìˆ˜</div>
            <div class="mode-tab ${ex.unitType==='count'?'active':''}" onclick="changeMode('count')" style="cursor:pointer; padding:5px 15px; border:1px solid #ddd; border-radius:20px;">íšŸìˆ˜</div>
            <div class="mode-tab ${ex.unitType==='time'?'active':''}" onclick="changeMode('time')" style="cursor:pointer; padding:5px 15px; border:1px solid #ddd; border-radius:20px;">ì‹œê°„</div>
        </div>
    `;

    let displayHTML = "";
    let editUI = "";

    // ê°’ í‘œì‹œ ë° í¸ì§‘ UI
    if (ex.unitType === 'weight') {
        displayHTML = `<div class="display-value" onclick="toggleEdit()" style="font-size:40px; color:#007bff; font-weight:bold; cursor:pointer; margin-bottom:20px;">${ex.weight}kg x ${ex.count}ê°œ</div>`;
        editUI = `<div id="editBox" style="display:${isEditing?'flex':'none'}; gap:20px; margin-bottom:20px; justify-content:center;">
                    <div>ë¬´ê²Œ: <input type="number" value="${ex.weight}" onchange="updateVal('weight', this.value)" style="width:60px;"></div>
                    <div>íšŸìˆ˜: <input type="number" value="${ex.count}" onchange="updateVal('count', this.value)" style="width:60px;"></div>
                  </div>`;
    } else if (ex.unitType === 'count') {
        displayHTML = `<div class="display-value" onclick="toggleEdit()" style="font-size:40px; color:#007bff; font-weight:bold; cursor:pointer; margin-bottom:20px;">${ex.count}íšŒ</div>`;
        editUI = `<div id="editBox" style="display:${isEditing?'block':'none'}; margin-bottom:20px;">íšŸìˆ˜: <input type="number" value="${ex.count}" onchange="updateVal('count', this.value)" style="width:60px;"></div>`;
    } else {
        displayHTML = `<div class="display-value" onclick="toggleEdit()" style="font-size:40px; color:#007bff; font-weight:bold; cursor:pointer; margin-bottom:20px;">${ex.time}ì´ˆ</div>`;
        editUI = `<div id="editBox" style="display:${isEditing?'block':'none'}; margin-bottom:20px;">ì‹œê°„: <input type="number" value="${ex.time}" onchange="updateVal('time', this.value)" style="width:60px;"></div>`;
    }

    const content = `
        <div class="exercise-image-area" style="height:250px; background:#f1f3f5; width:100%; display:flex; align-items:center; justify-content:center; margin-bottom:20px;">
            <span>[ ${ex.name} ê°€ì´ë“œ ]</span>
        </div>
        ${modeTabs}
        <h1 style="margin:0;">${ex.name}</h1>
        <h2 style="color:#888; margin-bottom:20px;">Set ${currentSet} / ${ex.sets}</h2>
        ${displayHTML}
        ${editUI}
    `;

    const btn = `
        <button class="wide-blue-btn" onclick="handleSetComplete()" style="width:100%; height:100px; background:#007bff; color:white; border:none; border-radius:15px; font-size:24px; font-weight:bold; margin-bottom:10px; cursor:pointer;">
            ${currentSet === ex.sets ? "ì¢…ëª© ì™„ë£Œ" : "ì„¸íŠ¸ ì™„ë£Œ"}
        </button>
        <button class="skip-ex-btn" onclick="moveToNext()" style="width:100%; height:50px; background:#eee; color:#666; border:none; border-radius:10px; font-size:16px; cursor:pointer;">ì´ ì„¸íŠ¸ ê±´ë„ˆë›°ê¸°</button>
    `;

    app.innerHTML = getFullLayout(content, btn);
}

function changeMode(mode) {
    exercises[currentExIdx].unitType = mode;
    isEditing = false;
    renderExercise();
}

function updateVal(field, val) {
    exercises[currentExIdx][field] = Number(val);
    renderExercise();
}

function toggleEdit() {
    isEditing = !isEditing;
    renderExercise();
}

function handleSetComplete() {
    workoutHistory.push({ name: exercises[currentExIdx].name, set: currentSet });
    moveToNext();
}

function moveToNext() {
    const ex = exercises[currentExIdx];
    if (currentSet < ex.sets) {
        currentSet++;
        startRest(false);
    } else {
        currentSet = 1;
        startRest(true);
    }
}

function startRest(isNextEx) {
    let timeLeft = isNextEx ? 30 : 20;
    const nextName = isNextEx ? (exercises[currentExIdx + 1]?.name || "ì¢…ë£Œ") : exercises[currentExIdx].name;

    const timerInterval = setInterval(() => {
        timeLeft--;
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            goNext();
        } else {
            app.innerHTML = getFullLayout(`
                <div class="exercise-image-area" style="height:250px; background:#eee; width:100%; display:flex; align-items:center; justify-content:center; margin-bottom:20px;"><span>[ íœ´ì‹ ì¤‘ ]</span></div>
                <h2 style="color:#adb5bd;">íœ´ì‹ ì¤‘...</h2>
                <h1 style="font-size:100px; margin:20px 0;">${timeLeft}s</h1>
                <p>ë‹¤ìŒ: <strong>${nextName}</strong></p>
            `, `<button class="wide-blue-btn" onclick="window.skipRest()" style="width:100%; height:100px; background:#007bff; color:white; border:none; border-radius:15px; font-size:24px; font-weight:bold; cursor:pointer;">íœ´ì‹ ê±´ë„ˆë›°ê¸°</button>`);
        }
    }, 1000);

    const goNext = () => {
        clearInterval(timerInterval);
        if (isNextEx) {
            currentExIdx++;
            if (currentExIdx < exercises.length) renderExercise();
            else renderReport();
        } else {
            renderExercise();
        }
    };
    window.skipRest = goNext;
}

function renderReport() {
    app.innerHTML = `<div class="container" style="text-align:center; padding-top:100px;"><h1>ğŸ† ì˜¤ìš´ì™„!</h1><button class="wide-blue-btn" onclick="location.reload()" style="width:80%; height:80px; background:#007bff; color:white; border:none; border-radius:15px; font-size:20px; font-weight:bold; cursor:pointer;">ì™„ë£Œ</button></div>`;
}

init();
